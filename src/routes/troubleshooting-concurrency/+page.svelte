<!-- auto-generated by QWER -->
<script lang="ts">
  /* eslint-disable @typescript-eslint/ban-ts-comment */
  // @ts-nocheck
  import Post from '$lib/layouts/post.svelte';
  import ImgZoom from '$lib/components/image_zoom.svelte';
  import Video from '$lib/components/video.svelte';
  import CodeCopy from '$lib/components/code_copy.svelte';
  import InfoBox from '$lib/components/info_box.svelte';
</script>

<Post>
  <article slot="post_content">
    <InfoBox statusType="info">
      <p>프로젝트를 진행하던 중 다음과 같은 상황에서 동시성 문제가 발생했습니다.</p>
      <ul>
        <li>[식당에 리뷰 작성] 평점, 리뷰 개수를 업데이트하는 로직</li>
        <li>[리뷰에 좋아요/싫어요] 좋아요/싫어요 개수를 업데이트하는 로직</li>
      </ul>
      <p><strong>해결한 방법은 똑같아서 좋아요/싫어요 로직을 예시로 설명하겠습니다.</strong></p>
    </InfoBox>
    <h2 id="1"><a href="#1">1. 동시성 문제 발생</a></h2>
    <div class="code-block titled">
      <h2 class="code-title">ReviewService.java</h2>
      <CodeCopy>
        <pre><code
            class="language-java">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token annotation punctuation">@Transactional</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addReviewReaction</span><span class="token punctuation">(</span><span class="token class-name">Long</span> memberId<span class="token punctuation">,</span> <span class="token class-name">Long</span> reviewId<span class="token punctuation">,</span> <span class="token class-name">Reaction</span> reactionType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">Review</span> review <span class="token operator">=</span> reviewRepository<span class="token punctuation">.</span><span class="token function">findBy</span><span class="token punctuation">(</span>reviewId<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                        <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ReviewException</span><span class="token punctuation">(</span><span class="token constant">NOT_FOUND_REVIEW</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">Member</span> member <span class="token operator">=</span> memberRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                        <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">MemberException</span><span class="token punctuation">(</span><span class="token constant">NOT_FOUND_MEMBER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token comment">// 이미 반응이 있다면 기존 반응 삭제 후 새로운 반응으로 업데이트</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token keyword">if</span> <span class="token punctuation">(</span>review<span class="token punctuation">.</span><span class="token function">hasReaction</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token function">updateReaction</span><span class="token punctuation">(</span>review<span class="token punctuation">,</span> member<span class="token punctuation">,</span> reactionType<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token function">addReaction</span><span class="token punctuation">(</span>review<span class="token punctuation">,</span> member<span class="token punctuation">,</span> reactionType<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        reviewRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>review<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">updateReaction</span><span class="token punctuation">(</span><span class="token class-name">Review</span> review<span class="token punctuation">,</span> <span class="token class-name">Member</span> member<span class="token punctuation">,</span> <span class="token class-name">Reaction</span> reaction<span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">ReviewReaction</span> reviewReaction <span class="token operator">=</span> review<span class="token punctuation">.</span><span class="token function">getReviewReactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                              <span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                              <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>r <span class="token operator">-></span> r<span class="token punctuation">.</span><span class="token function">getMember</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>member<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                              <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                              <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                                <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ReviewException</span><span class="token punctuation">(</span><span class="token constant">NOT_FOUND_REVIEW_REACTION</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token comment">// 기존 반응과 같다면 반응 삭제 (아무것도 안누른 상태로 변경)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token keyword">if</span> <span class="token punctuation">(</span>reviewReaction<span class="token punctuation">.</span><span class="token function">getReaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> reaction<span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            reviewReactionRepository<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>reviewReaction<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            review<span class="token punctuation">.</span><span class="token function">removeReviewReaction</span><span class="token punctuation">(</span>reviewReaction<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token keyword">if</span> <span class="token punctuation">(</span>reaction <span class="token operator">==</span> <span class="token class-name">Reaction</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                review<span class="token punctuation">.</span><span class="token function">decreaseLikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                review<span class="token punctuation">.</span><span class="token function">decreaseDislikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 기존 반응과 다르다면 반응 업데이트</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            reviewReaction<span class="token punctuation">.</span><span class="token function">changeReaction</span><span class="token punctuation">(</span>reaction<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token keyword">if</span> <span class="token punctuation">(</span>reaction <span class="token operator">==</span> <span class="token class-name">Reaction</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                review<span class="token punctuation">.</span><span class="token function">increaseLikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                review<span class="token punctuation">.</span><span class="token function">decreaseDislikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                review<span class="token punctuation">.</span><span class="token function">increaseDislikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                review<span class="token punctuation">.</span><span class="token function">decreaseLikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addReaction</span><span class="token punctuation">(</span><span class="token class-name">Review</span> review<span class="token punctuation">,</span> <span class="token class-name">Member</span> member<span class="token punctuation">,</span> <span class="token class-name">Reaction</span> reaction<span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">ReviewReaction</span> reviewReaction <span class="token operator">=</span> <span class="token class-name">ReviewReaction</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>review<span class="token punctuation">,</span> member<span class="token punctuation">,</span> reaction<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        review<span class="token punctuation">.</span><span class="token function">addReviewReaction</span><span class="token punctuation">(</span>reviewReaction<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        reviewReactionRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>reviewReaction<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token keyword">if</span> <span class="token punctuation">(</span>reaction <span class="token operator">==</span> <span class="token class-name">Reaction</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            review<span class="token punctuation">.</span><span class="token function">increaseLikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            review<span class="token punctuation">.</span><span class="token function">increaseDislikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>처음엔 위 코드처럼 별다른 고민 없이 작성했습니다. 하지만 테스트를 진행하던 중 동시성 문제가 발생했습니다.</p>
    <div class="code-block titled">
      <h2 class="code-title">테스트 코드</h2>
      <CodeCopy>
        <pre><code
            class="language-java">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token annotation punctuation">@Test</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">void</span> <span class="token function">addReviewReaction_concurrency</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=========start=========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token comment">// given</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token keyword">int</span> numberOfThreads <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">ExecutorService</span> service <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newFixedThreadPool</span><span class="token punctuation">(</span>numberOfThreads<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">CountDownLatch</span> latch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span>numberOfThreads<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span> memberIds <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Long</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">4L</span><span class="token punctuation">,</span> <span class="token number">6L</span><span class="token punctuation">,</span> <span class="token number">7L</span><span class="token punctuation">,</span> <span class="token number">8L</span><span class="token punctuation">}</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token comment">// when</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> numberOfThreads<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token keyword">int</span> idx <span class="token operator">=</span> i<span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            service<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                <span class="token keyword">try</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                    <span class="token comment">// TODO: Replace with actual parameters</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                    <span class="token class-name">Long</span> memberId <span class="token operator">=</span> memberIds<span class="token punctuation">[</span>idx<span class="token punctuation">]</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                    <span class="token class-name">Long</span> reviewId <span class="token operator">=</span> <span class="token number">3034L</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                    <span class="token class-name">Reaction</span> reactionType <span class="token operator">=</span> <span class="token class-name">Reaction</span><span class="token punctuation">.</span><span class="token constant">LIKE</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                    reviewService<span class="token punctuation">.</span><span class="token function">addReviewReaction</span><span class="token punctuation">(</span>memberId<span class="token punctuation">,</span> reviewId<span class="token punctuation">,</span> reactionType<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                    latch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token comment">// then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        latch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// wait for all threads to finish</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        service<span class="token punctuation">.</span><span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"=========end=========="</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ReviewReaction</span><span class="token punctuation">></span></span> reactions <span class="token operator">=</span> reviewReactionRepository<span class="token punctuation">.</span><span class="token function">findAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">Review</span> review <span class="token operator">=</span> reviewRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">3034L</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token function">assertSoftly</span><span class="token punctuation">(</span>softly <span class="token operator">-></span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            softly<span class="token punctuation">.</span><span class="token function">assertThat</span><span class="token punctuation">(</span>reactions<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            softly<span class="token punctuation">.</span><span class="token function">assertThat</span><span class="token punctuation">(</span>review<span class="token punctuation">.</span><span class="token function">getLikeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEqualTo</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      4개의 스레드를 생성하여 4명의 유저가 동시에 좋아요를 누르는 상황을 시뮬레이션 했습니다. 그 결과 다음과 같은 에러가
      발생했습니다.
    </p>
    <p><ImgZoom src="/troubleshooting-concurrency/image-2.png" alt="Alt text"></ImgZoom></p>
    <p>
      해당 오류는 MySQL에서 발생하는 에러로, 동시에 여러 트랜잭션이 같은 데이터에 접근하여 <code
        class="inline-code-block">
        데드락
      </code>
      이 발생했다는 의미입니다.
    </p>
    <InfoBox statusType="tip">
      <p>
        <code class="inline-code-block">데드락</code>
        이란?
      </p>
      <p>
        한국말로 <code class="inline-code-block">교착 상태</code>
        를 뜻하며, 두 개 이상의 프로세스나 스레드가 같은 자원을 사용하려고 할 때 발생하는 상황입니다.
      </p>
      <p>서로 상대방의 작업이 끝나기만을 기다리고 있기 때문에, 무한정 기다리는 상태가 됩니다.</p>
    </InfoBox>
    <p>때문에 쿼리가 정상적으로 실행되지 않고, 다음과 같은 결과가 나옵니다.</p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-sql">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">select</span> r<span class="token punctuation">.</span>id<span class="token punctuation">,</span> r<span class="token punctuation">.</span>like_count<span class="token punctuation">,</span> r<span class="token punctuation">.</span>dislike_count <span class="token keyword">from</span> review r <span class="token keyword">where</span> id <span class="token operator">=</span> <span class="token number">3034</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> review_reaction <span class="token keyword">where</span> review_id <span class="token operator">=</span> <span class="token number">3034</span><span class="token punctuation">;</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      <ImgZoom src="/troubleshooting-concurrency/image.png" alt="Alt text"></ImgZoom>
      <ImgZoom src="/troubleshooting-concurrency/image-1.png" alt="Alt text"></ImgZoom>
    </p>
    <p>원래라면 like_count가 4가되고, review_reaction 테이블에는 4개의 row가 생성되어야 합니다.</p>
    <p>하지만 데드락이 발생하여 like_count가 1이 되고, review_reaction 테이블에는 1개의 row만 생성되었습니다.</p>
    <h2 id="2"><a href="#2">2. 해결 방법</a></h2>
    <p>
      데드락이 발생한 이유는 <code class="inline-code-block">동시에 같은 데이터에 접근</code>
      했기 때문입니다. 따라서 동시에 접근하지 못하도록
      <code class="inline-code-block">Lock</code>
      을 걸어주면 해결할 수 있습니다.
    </p>
    <p>
      많은 방법이 존재하지만, 여기서는 <code class="inline-code-block">Pessimistic Locking&lpar;비관적 락&rpar;</code>
      을 사용했습니다.
    </p>
    <h3 id="2-1-pessimistic-locking"><a href="#2-1-pessimistic-locking">2-1. Pessimistic Locking</a></h3>
    <InfoBox statusType="info">
      <p>
        <code class="inline-code-block">Pessimistic Locking</code>
        이란?
      </p>
      <p>데이터를 사용하는 동안 다른 사용자가 해당 데이터를 변경하지 못하도록 데이터에 락을 거는 방법입니다.</p>
      <ul>
        <li>
          <code class="inline-code-block">PESSIMISTIC_READ</code>
          : 락이 걸린 데이터를 다른 사용자가 읽을 수 있지만, 수정/삭제할 수는 없음
        </li>
        <li>
          <code class="inline-code-block">PESSIMISTIC_WRITE</code>
          : 락이 걸린 데이터를 다른 사용자가 읽을 수 없고, 수정/삭제도 할 수 없음
        </li>
      </ul>
    </InfoBox>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-java">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token annotation punctuation">@Repository</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">ReviewRepository</span> <span class="token keyword">extends</span> <span class="token class-name">JpaRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Review</span><span class="token punctuation">,</span> <span class="token class-name">Long</span><span class="token punctuation">></span></span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token comment">// ...</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token annotation punctuation">@Lock</span><span class="token punctuation">(</span><span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_READ</span><span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">"select r from Review r where r.id = :reviewId"</span><span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Review</span><span class="token punctuation">></span></span> <span class="token function">findByIdWithPessimisticLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> reviewId<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token punctuation">}</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      JPA에서는 <code class="inline-code-block">@Lock</code>
      어노테이션을 사용하여 락을 걸 수 있습니다. 처음엔
      <code class="inline-code-block">PESSIMISTIC_READ</code>
      를 사용해봤는데, 똑같이 데드락이 발생했습니다.
    </p>
    <p>
      이유는 <code class="inline-code-block">PESSIMISTIC_READ</code>
      는 데이터를 읽을 때만 락을 걸기 때문입니다. 따라서 데이터를 읽은 후에는 락이 풀리기 때문에, 다른 사용자가 데이터를
      수정할 수 있습니다.
    </p>
    <p>
      그래서 <code class="inline-code-block">PESSIMISTIC_WRITE</code>
      를 사용하여 데이터를 읽고 수정할 때까지 락을 걸어주었습니다.
    </p>
    <div class="code-block titled">
      <h2 class="code-title">ReviewService.java</h2>
      <CodeCopy>
        <pre><code
            class="language-java">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token annotation punctuation">@Transactional</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addReviewReaction</span><span class="token punctuation">(</span><span class="token class-name">Long</span> memberId<span class="token punctuation">,</span> <span class="token class-name">Long</span> reviewId<span class="token punctuation">,</span> <span class="token class-name">Reaction</span> reactionType<span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">Review</span> review <span class="token operator">=</span> reviewRepository<span class="token punctuation">.</span><span class="token function">findByIdWithPessimisticLock</span><span class="token punctuation">(</span>reviewId<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                        <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">ReviewException</span><span class="token punctuation">(</span><span class="token constant">NOT_FOUND_REVIEW</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token class-name">Member</span> member <span class="token operator">=</span> memberRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">                                        <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> <span class="token keyword">new</span> <span class="token class-name">MemberException</span><span class="token punctuation">(</span><span class="token constant">NOT_FOUND_MEMBER</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token comment">// 이미 반응이 있다면 기존 반응 삭제 후 새로운 반응으로 업데이트</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token keyword">if</span> <span class="token punctuation">(</span>review<span class="token punctuation">.</span><span class="token function">hasReaction</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token function">updateReaction</span><span class="token punctuation">(</span>review<span class="token punctuation">,</span> member<span class="token punctuation">,</span> reactionType<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            <span class="token function">addReaction</span><span class="token punctuation">(</span>review<span class="token punctuation">,</span> member<span class="token punctuation">,</span> reactionType<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        reviewRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>review<span class="token punctuation">)</span><span class="token punctuation">;</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token comment">// ...</span></div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      만들어준 <code class="inline-code-block">findByIdWithPessimisticLock</code>
       메서드를 사용하여 데이터가 변경되는 Review 테이블에 락을 걸어주었습니다.
    </p>
    <p>그 결과 데드락이 발생하지 않고, 정상적으로 테스트가 통과되었습니다.</p>
    <p>
      <ImgZoom src="/troubleshooting-concurrency/image-3.png" alt="Alt text"></ImgZoom>
      <ImgZoom src="/troubleshooting-concurrency/image-4.png" alt="Alt text"></ImgZoom>
    </p>
    <h2 id="3"><a href="#3">3. 마치며</a></h2>
    <p>처음으로 동시성 문제를 접해봤는데, DB에서 락을 걸어주는 방법으로 해결할 수 있었습니다.</p>
    <p>
      이외에도 다양한 방법들이 존재하는 것 같은데 프로젝트 후 시간이 남는다면 다른 방법들로 동시성 문제를 해결할
      예정입니다. (Optimistic Locking, Redis를 활용한 분산 락 등)
    </p>
  </article>
</Post>
