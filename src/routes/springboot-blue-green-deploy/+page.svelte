<!-- auto-generated by QWER -->
<script lang="ts">
  /* eslint-disable @typescript-eslint/ban-ts-comment */
  // @ts-nocheck
  import Post from '$lib/layouts/post.svelte';
  import ImgZoom from '$lib/components/image_zoom.svelte';
  import Video from '$lib/components/video.svelte';
  import CodeCopy from '$lib/components/code_copy.svelte';
  import InfoBox from '$lib/components/info_box.svelte';
</script>

<Post>
  <article slot="post_content">
    <h1 id=""><a href="#">개요</a></h1>
    <p>
      <a href="https://github.com/kingseungil/matgo" rel="external">개인프로젝트</a>
      를 진행하면서 Blue Green Deploy를 구현해보았습니다.
    </p>
    <p>
      전엔 <code class="inline-code-block">docker-compose</code>
      를 이용하여 수동으로 ec2 서버에 들어가서
      <code class="inline-code-block">docker-compose up</code>
      을 통해 배포를 진행하였습니다.
    </p>
    <p>
      이번엔 꼭 CI/CD를 적용해보고자 <code class="inline-code-block">github actions</code>
      를 이용하여 배포를 진행해보았습니다.
    </p>
    <h1 id="ci-cd"><a href="#ci-cd">CI/CD</a></h1>
    <p>CI/CD를 구축하는 방법은 여러가지가 있습니다.</p>
    <p>
      대표적으로 <code class="inline-code-block">Jenkins</code>
      ,
      <code class="inline-code-block">Travis CI</code>
      ,
      <code class="inline-code-block">Github Actions</code>
       등이 있습니다.
    </p>
    <p>
      또는 각 클라우드 서비스에 존재하는 CI/CD 서비스를 이용할 수도 있습니다. (e.g. AWS CodePipeline, NCP CodePipeline
      등)
    </p>
    <p>
      취준생은 가난하고, 클라우드 서비스는 울렁증이 있어서.. 그나마 무료인 <code class="inline-code-block">
        Github Actions
      </code>
      를 이용하여 배포를 진행해보았습니다.
    </p>
    <h2 id="github-actions"><a href="#github-actions">Github Actions</a></h2>
    <InfoBox statusType="info" statusName="Github Actions란?">
      <p>
        GitHub Actions는 GitHub에서 제공하는 서비스로, 빌드, 테스트, 배포 파이프라인을 자동화할 수 있는 <code
          class="inline-code-block">
          CI&lpar;Continuous Integration, 지속 통합&rpar;
        </code>
        와
        <code class="inline-code-block">CD&lpar;Continuous Deployment, 지속 배포&rpar;</code>
         플랫폼입니다.
      </p>
      <p>GitHub Actions를 사용하면 GitHub 리포지토리에서 손쉽게 CI/CD 결과를 확인하고 관리할 수 있습니다.</p>
      <p>
        또한, YAML 포맷을 사용하여 가독성이 높고, 이미 구현되어 있는 수많은 액션을 활용하여 간단하게 CI/CD 플로우를
        작성할 수 있습니다.
      </p>
      <p>
        출처 : <a href="https://tech.kakaoenterprise.com/180" rel="external">https://tech.kakaoenterprise.com/180</a>
      </p>
    </InfoBox>
    <p>
      Github Actions는 <code class="inline-code-block">.github/workflows</code>
      디렉토리에
      <code class="inline-code-block">yml</code>
       파일을 생성하여 workflow를 정의합니다.
    </p>
    <details>
      <summary>deploy.yml</summary>

      <div class="code-block titled">
        <h2 class="code-title">deploy.yml</h2>
        <CodeCopy>
          <pre><code
              class="language-yaml">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token key atrule">name</span><span class="token punctuation">:</span> auto deploy</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token key atrule">on</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token key atrule">push</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">branches</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> master</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token key atrule">jobs</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token key atrule">push_to_ncp_registry</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">name</span><span class="token punctuation">:</span> Push to ncp container registry</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">services</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token key atrule">redis</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">image</span><span class="token punctuation">:</span> redis</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token punctuation">-</span> 6379<span class="token punctuation">:</span><span class="token number">6379</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token key atrule">elasticsearch</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">image</span><span class="token punctuation">:</span> elasticsearch<span class="token punctuation">:</span>8.6.2</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">ports</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token punctuation">-</span> 9200<span class="token punctuation">:</span><span class="token number">9200</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">options</span><span class="token punctuation">:</span> <span class="token punctuation">-</span>e="discovery.type=single<span class="token punctuation">-</span>node"</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">steps</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Checkout</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/checkout@v3</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up JDK 17</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> actions/setup<span class="token punctuation">-</span>java@v2</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">with</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">distribution</span><span class="token punctuation">:</span> <span class="token string">'adopt'</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">java-version</span><span class="token punctuation">:</span> <span class="token string">'17'</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set environment values</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">run</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          cd ./src/main/resources</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          mkdir properties</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          cd properties</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          touch ./env.properties</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          echo "&#36;{{ secrets.ENV }}" > ./env.properties</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build with Gradle</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> gradle/gradle<span class="token punctuation">-</span>build<span class="token punctuation">-</span>action@bd5760595778326ba7f1441bcf7e88b49de61a25 <span class="token comment"># v2.6.0</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">with</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">arguments</span><span class="token punctuation">:</span> build generateSwaggerUI</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Set up Docker Buildx</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/setup<span class="token punctuation">-</span>buildx<span class="token punctuation">-</span>action@v2</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Login to NCP Container Registry</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/login<span class="token punctuation">-</span>action@v2</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">with</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">registry</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_CONTAINER_REGISTRY <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">username</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_ACCESS_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">password</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_SECRET_KEY <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> build and push</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> docker/build<span class="token punctuation">-</span>push<span class="token punctuation">-</span>action@v3</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">with</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">context</span><span class="token punctuation">:</span> .</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">file</span><span class="token punctuation">:</span> ./docker/api/Dockerfile</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">push</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">tags</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            &#36;{{ secrets.NCP_CONTAINER_REGISTRY }}/matgo:&#36;{{ github.sha }}</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            &#36;{{ secrets.NCP_CONTAINER_REGISTRY }}/matgo:latest</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">cache-from</span><span class="token punctuation">:</span> type=registry<span class="token punctuation">,</span>ref=&#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_CONTAINER_REGISTRY <span class="token punctuation">}</span><span class="token punctuation">}</span>/matgo<span class="token punctuation">:</span>latest</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">cache-to</span><span class="token punctuation">:</span> type=inline</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">secrets</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            GIT_AUTH_TOKEN=&#36;{{ secrets.GIT_TOKEN }}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token key atrule">pull_from_ncp_registry</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">name</span><span class="token punctuation">:</span> Connect server ssh and pull from ncp container registry</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">needs</span><span class="token punctuation">:</span> push_to_ncp_registry</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">runs-on</span><span class="token punctuation">:</span> ubuntu<span class="token punctuation">-</span>latest</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">steps</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> connect ssh</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> appleboy/ssh<span class="token punctuation">-</span>action@master</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">with</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">host</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_SERVER_IP <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">username</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_SERVER_USERNAME <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">password</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_SERVER_PASSWORD <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">port</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.NCP_SERVER_PORT <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">script</span><span class="token punctuation">:</span> <span class="token punctuation">|</span><span class="token scalar string"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            cd matgo</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            git pull</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            echo "&#36;{{ secrets.NCP_SECRET_KEY }}" | docker login &#36;{{ secrets.NCP_CONTAINER_REGISTRY }} --username &#36;{{ secrets.NCP_ACCESS_KEY }} --password-stdin</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            docker pull &#36;{{ secrets.NCP_CONTAINER_REGISTRY }}/matgo:latest</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            cd script</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            chmod +x deploy.sh</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            ./deploy.sh</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">            docker image prune -f --filter "until=24h"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Notify to slack</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">uses</span><span class="token punctuation">:</span> 8398a7/action<span class="token punctuation">-</span>slack@v3</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">with</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">status</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> job.status <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">author_name</span><span class="token punctuation">:</span> Matgo</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">fields</span><span class="token punctuation">:</span> repo<span class="token punctuation">,</span>message<span class="token punctuation">,</span>commit<span class="token punctuation">,</span>action<span class="token punctuation">,</span>eventName<span class="token punctuation">,</span>ref<span class="token punctuation">,</span>workflow<span class="token punctuation">,</span>job<span class="token punctuation">,</span>took</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">env</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">          <span class="token key atrule">SLACK_WEBHOOK_URL</span><span class="token punctuation">:</span> &#36;<span class="token punctuation">{</span><span class="token punctuation">{</span> secrets.SLACK_WEBHOOK_URL <span class="token punctuation">}</span><span class="token punctuation">}</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">        <span class="token key atrule">if</span><span class="token punctuation">:</span> always()</div></div>`}</code></pre>
        </CodeCopy>
      </div>
    </details>

    <p>위 코드를 살펴보기 전에 Github Actions의 구조를 살펴보겠습니다.</p>
    <h3 id="github-actions"><a href="#github-actions">Github Actions 구조</a></h3>
    <h4 id="workflow"><a href="#workflow">workflow</a></h4>
    <p>
      Github Actions는 <code class="inline-code-block">workflow</code>
      를 기반으로 동작합니다.
    </p>
    <p>
      workflow는 쉽게 말해 &#39;작업의 흐름&#39;으로, 특정한 목적을 위한 일련의 실행 트리거, 환경, 기능들을 모두
      포함합니다.
    </p>
    <p>
      workflow 파일에서 <code class="inline-code-block">on</code>
       속성을 통해 해당 workflow가 어떤 이벤트에 반응하여 동작할지 정의합니다.
    </p>
    <div class="code-block">
      <CodeCopy>
        <pre><code
            class="language-yaml">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token key atrule">on</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token key atrule">push</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token key atrule">branches</span><span class="token punctuation">:</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token punctuation">-</span> master</div></div>`}</code></pre>
      </CodeCopy>
    </div>
    <p>
      위 코드는 <code class="inline-code-block">master</code>
       브랜치에 push가 발생하면 workflow가 동작하도록 정의한 것입니다.
    </p>
    <h4 id="job"><a href="#job">job</a></h4>
    <p>
      workflow는 하나 이상의 <code class="inline-code-block">job</code>
      으로 구성됩니다.
    </p>
    <p>
      job은 github actions에서 <strong>독립된 환경에서 돌아가는 하나의 처리 단위</strong>
      를 의미합니다.
    </p>
    <p>
      job에서 필수적으로 정의해야 하는 속성은 <strong>runs-on</strong>
      과
      <strong>steps</strong>
      입니다.
    </p>
    <InfoBox statusType="info" statusName="runs-on">
      <p>runs-on에는 Job을 실행할 러너(환경)을 정의합니다.</p>
      <p>
        위 코드같은 경우 <code class="inline-code-block">ubuntu-latest</code>
        를 사용하였습니다.
      </p>
      <p>
        OS마다 비용이 다르기 때문에, 자신의 프로젝트에 맞는 러너를 선택하여 사용하면 됩니다.
        <a
          href="https://docs.github.com/en/billing/managing-billing-for-github-actions/about-billing-for-github-actions#about-billing-for-github-actions"
          rel="external">
          러너 비용
        </a>
      </p>
    </InfoBox>
    <InfoBox statusType="info" statusName="steps">
      <p>steps에는 job에서 실행할 작업들을 정의합니다.</p>
      <p>
        <code class="inline-code-block">name</code>
        속성은 해당 작업의 이름을 정의하고,
        <code class="inline-code-block">uses</code>
         속성은 해당 작업을 실행할 액션을 정의합니다.
      </p>
    </InfoBox>
    <p>이 외에 속성들은 검색하면 쉽게 찾을 수 있으니 생략하겠습니다.</p>
    <h3 id="secret"><a href="#secret">Secret 설정하기</a></h3>
    <p>
      deploy.yml 파일을 보면 <code class="inline-code-block">&lcub;&lcub; secrets.ENV &rcub;&rcub;</code>
       같은 부분이 보입니다. 이는 Github Actions에서 사용하는 환경변수를 의미합니다.
    </p>
    <p>
      Github Actions에서 사용하는 환경변수는 <code class="inline-code-block">Settings &gt; Secrets</code>
      에서 설정할 수 있습니다.
    </p>
    <p>Secrets and variables의 Actions 부분을 클릭하고 사용할 환경변수를 추가합니다.</p>
    <p><ImgZoom src="/springboot-blue-green-deploy/image.png" alt="Alt text"></ImgZoom></p>
    <p>이제 master 브랜치에 push가 발생하면 위 코드대로 workflow가 동작하게 됩니다.</p>
    <h2 id="deploy-yml"><a href="#deploy-yml">deploy.yml 코드 살펴보기</a></h2>
    <p>전체적인 흐름은 다음과 같습니다.</p>
    <ol>
      <li>
        master 브랜치에 push가 발생하면 <code class="inline-code-block">push_to_ncp_registry</code>
        job이 동작합니다.
        <ul>
          <li>스프링부트가 빌드될 때, 테스트가 실행되기 때문에 필요한 redis, elasticsearch를 서비스로 실행합니다.</li>
          <li>그리고 gradle을 이용하여 빌드를 진행합니다.</li>
          <li>빌드가 완료되면 해당 이미지를 NCP Container Registry에 push합니다.</li>
        </ul>
      </li>
      <li>
        <code class="inline-code-block">push_to_ncp_registry</code>
        job이 완료되면
        <code class="inline-code-block">pull_from_ncp_registry</code>
        job이 동작합니다.
        <ul>
          <li>ssh를 이용하여 NCP 서버에 접속합니다.</li>
          <li>
            해당 서버에서 <code class="inline-code-block">docker pull</code>
            을 통해 이미지를 받아옵니다.
          </li>
          <li>
            <code class="inline-code-block">docker-compose</code>
            를 이용하여 컨테이너를 실행합니다.
          </li>
        </ul>
      </li>
      <li>
        <code class="inline-code-block">pull_from_ncp_registry</code>
        job이 완료되면
        <code class="inline-code-block">Notify to slack</code>
        job이 동작합니다.
        <ul>
          <li>해당 job이 성공했는지 실패했는지에 따라 slack에 알림을 보냅니다.</li>
        </ul>
      </li>
    </ol>
    <p>
      여기서 살펴봐야 할 부분은 <code class="inline-code-block">pull_from_ncp_registry</code>
       입니다.
    </p>
    <p>
      blue-green deploy를 구현하기 위해 <code class="inline-code-block">deploy.sh</code>
      를 실행하는데 이 파일은 다음과 같습니다.
    </p>
    <details>
      <summary>deploy.sh</summary>

      <div class="code-block">
        <CodeCopy>
          <pre><code
              class="language-bash">{@html String.raw`<div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token shebang important">#! /bin/bash</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token builtin class-name">cd</span> <span class="token punctuation">..</span>/docker</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment"># nginx container가 없으면 실행</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">&#36;(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token string">"matgo-proxy"</span><span class="token variable">)</span></span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Starting Nginx ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> matgo-proxy</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">else</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Nginx already running ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment"># db container가 없으면 실행</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">&#36;(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token string">"matgo-db"</span><span class="token variable">)</span></span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Starting database ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> matgo-db</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">else</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Database already running ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment"># redis container가 없으면 실행</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">&#36;(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token string">"matgo-redis"</span><span class="token variable">)</span></span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Starting redis ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> matgo-redis</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">else</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Redis already running ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment"># es container가 없으면 실행</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable"><span class="token variable">&#36;(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token string">"matgo-es"</span><span class="token variable">)</span></span> <span class="token parameter variable">-eq</span> <span class="token number">0</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Starting elasticsearch ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> matgo-es</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">else</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### Elasticsearch already running ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token builtin class-name">echo</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token assign-left variable">IS_BLUE</span><span class="token operator">=</span><span class="token variable"><span class="token variable">&#36;(</span><span class="token function">docker</span> <span class="token function">ps</span> <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-c</span> <span class="token string">"blue"</span><span class="token variable">)</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token string">"<span class="token variable">&#36;IS_BLUE</span>"</span> <span class="token parameter variable">-eq</span> <span class="token number">1</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### BLUE => GREEN ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"1. green container up"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> matgo-server-green</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"Waiting for the green application to fully start..."</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">sleep</span> <span class="token number">45</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"2. reload nginx"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">cd</span> /root/matgo/docker/nginx <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token comment"># 각자 경로에 맞게 수정</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> matgo-proxy /bin/bash <span class="token parameter variable">-c</span> <span class="token string">"cp /etc/nginx/nginx.green.conf /etc/nginx/nginx.conf &amp;&amp; nginx -s reload"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token assign-left variable">MAX_ATTEMPTS</span><span class="token operator">=</span><span class="token number">10</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token assign-left variable">ATTEMPTS</span><span class="token operator">=</span><span class="token number">0</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">&#36;ATTEMPTS</span> <span class="token parameter variable">-lt</span> <span class="token variable">&#36;MAX_ATTEMPTS</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token builtin class-name">echo</span> <span class="token string">"3. green container health check"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token function">sleep</span> <span class="token number">3</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token assign-left variable">REQUEST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">&#36;(</span><span class="token function">curl</span> http://<span class="token punctuation">{</span>url<span class="token punctuation">}</span>/<span class="token variable">)</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment">#    REQUEST=&#36;(curl http://127.0.0.1/)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">&#36;REQUEST</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">echo</span> <span class="token string">"4. green container health check success"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">break</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token assign-left variable">ATTEMPTS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">&#36;((</span>ATTEMPTS<span class="token operator">+</span><span class="token number">1</span><span class="token variable">))</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">&#36;ATTEMPTS</span> <span class="token parameter variable">-eq</span> <span class="token variable">&#36;MAX_ATTEMPTS</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">echo</span> <span class="token string">"Green health check failed after <span class="token variable">&#36;MAX_ATTEMPTS</span> attempts. Reverting Nginx configuration."</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> matgo-proxy /bin/bash <span class="token parameter variable">-c</span> <span class="token string">"cp /etc/nginx/nginx.blue.conf /etc/nginx/nginx.conf &amp;&amp; nginx -s reload"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">exit</span> <span class="token number">1</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token keyword">done</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"5. blue container down"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> stop matgo-server-blue</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">else</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"### GREEN => BLUE ###"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"1. blue container up"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> up <span class="token parameter variable">-d</span> matgo-server-blue</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"Waiting for the blue application to fully start..."</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">sleep</span> <span class="token number">45</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"2. reload nginx"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">cd</span> /root/matgo/docker/nginx <span class="token operator">||</span> <span class="token builtin class-name">exit</span> <span class="token comment"># 각자 경로에 맞게 수정</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> matgo-proxy /bin/bash <span class="token parameter variable">-c</span> <span class="token string">"cp /etc/nginx/nginx.blue.conf /etc/nginx/nginx.conf &amp;&amp; nginx -s reload"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token assign-left variable">MAX_ATTEMPTS</span><span class="token operator">=</span><span class="token number">10</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token assign-left variable">ATTEMPTS</span><span class="token operator">=</span><span class="token number">0</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token keyword">while</span> <span class="token punctuation">[</span> <span class="token variable">&#36;ATTEMPTS</span> <span class="token parameter variable">-lt</span> <span class="token variable">&#36;MAX_ATTEMPTS</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">do</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token builtin class-name">echo</span> <span class="token string">"3. blue container health check"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token function">sleep</span> <span class="token number">3</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token assign-left variable">REQUEST</span><span class="token operator">=</span><span class="token variable"><span class="token variable">&#36;(</span><span class="token function">curl</span> http://<span class="token punctuation">{</span>url<span class="token punctuation">}</span>/<span class="token variable">)</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token comment">#    REQUEST=&#36;(curl http://127.0.0.1/)</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token parameter variable">-n</span> <span class="token string">"<span class="token variable">&#36;REQUEST</span>"</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">echo</span> <span class="token string">"4. blue container health check success"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">break</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token assign-left variable">ATTEMPTS</span><span class="token operator">=</span><span class="token variable"><span class="token variable">&#36;((</span>ATTEMPTS<span class="token operator">+</span><span class="token number">1</span><span class="token variable">))</span></span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">&#36;ATTEMPTS</span> <span class="token parameter variable">-eq</span> <span class="token variable">&#36;MAX_ATTEMPTS</span> <span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token keyword">then</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">echo</span> <span class="token string">"Blue health check failed after <span class="token variable">&#36;MAX_ATTEMPTS</span> attempts. Reverting Nginx configuration."</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token function">docker-compose</span> <span class="token builtin class-name">exec</span> matgo-proxy /bin/bash <span class="token parameter variable">-c</span> <span class="token string">"cp /etc/nginx/nginx.green.conf /etc/nginx/nginx.conf &amp;&amp; nginx -s reload"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">      <span class="token builtin class-name">exit</span> <span class="token number">1</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">    <span class="token keyword">fi</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token keyword">done</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token builtin class-name">echo</span> <span class="token string">"5. green container down"</span></div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content">  <span class="token function">docker-compose</span> stop matgo-server-green</div></div><div class="code-line"><div class="code-linenotation"><span class="no-line-number"></span><span class="no-line-diff"></span></div><div class="code-content"><span class="token keyword">fi</span></div></div>`}</code></pre>
        </CodeCopy>
      </div>
    </details>

    <p>
      <code class="inline-code-block">deploy.sh</code>
      는 다음과 같은 역할을 합니다.
    </p>
    <ol>
      <li>nginx, db, redis, elasticsearch 컨테이너가 없으면 실행합니다.</li>
      <li>현재 실행중인 컨테이너가 blue 컨테이너인지 green 컨테이너인지 확인합니다.</li>
      <li>현재 실행중인 컨테이너가 blue 컨테이너라면 green 컨테이너를 실행합니다.</li>
      <li>
        nginx 설정을 green 컨테이너로 변경합니다. (프록시 설정을 바꿔줘서 green 컨테이너로 요청이 들어가도록 합니다.)
      </li>
      <li>green 컨테이너가 정상적으로 실행되었는지 확인합니다.</li>
      <li>blue 컨테이너를 종료합니다.</li>
    </ol>
    <p>이렇게되면 blue 컨테이너가 green 컨테이너로 교체되는 것이고, 이 과정에서 downtime이 발생하지 않습니다.</p>
    <InfoBox statusType="tip" statusName="downtime이란?">
      <p>downtime은 서비스가 중단되는 시간을 의미합니다.</p>
      <p>blue-green deploy를 하지 않는다면, 배포 과정에서 downtime이 발생합니다.</p>
      <p>docker-compose up을 통해 컨테이너를 실행하면, 컨테이너가 실행되는 동안 서비스가 중단됩니다.</p>
      <p>하지만 blue-green deploy를 하게되면, 컨테이너를 실행하는 과정에서 downtime이 발생하지 않습니다.</p>
    </InfoBox>
    <h1 id=""><a href="#">마치며</a></h1>
    <p>모든 코드를 해당 글에 담지 않았고, 전체적인 흐름만 담았습니다.</p>
    <p>
      글에서는 설명하지 않았지만 <code class="inline-code-block">docker-compose.yml</code>
       파일도 작성해야하고,
    </p>
    <p>
      <code class="inline-code-block">nginx.green.conf</code>
      ,
      <code class="inline-code-block">nginx.blue.conf</code>
       파일도 작성해야합니다.
    </p>
    <p>
      해당 코드는 <a href="https://github.com/kingseungil/matgo" rel="external">여기</a>
      에서 확인할 수 있습니다.
    </p>
  </article>
</Post>
